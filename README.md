# Telescan

Утилита для массовой работы с Telegram сессиями на базе [Telethon](https://github.com/LonamiWebs/Telethon) и [opentele](https://github.com/gdelgado14/opentele). Программа умеет конвертировать данные настольного клиента (`tdata`) в `.session` файлы и обратно, а также автоматически проверять валидность сессий с подробной отчётностью.

## Основные возможности

- Конвертация директорий `tdata` в `.session` файлы Telethon и обратная операция.
- Проверка `.session` файлов, директорий с сессиями, CSV со StringSession и `tdata` с отображением прогресса.
- Гибкое управление параллелизмом, повторными попытками, backoff и задержками между запросами.
- Ротация API ключей и прокси (стратегии `round`, `random`, `sticky`).
- Отчёты в CSV/JSON с раздельными списками валидных и невалидных сессий.

## Требования

- Python 3.9+
- Библиотеки: `telethon`, `tqdm`, `opentele` (для работы с tdata), `tomli` при использовании Python 3.10 и ниже.

Пример установки в виртуальное окружение:

```bash
python3 -m venv .venv
source .venv/bin/activate
pip install telethon tqdm opentele tomli pysocks
```

## Конфигурация

Настройки хранятся в файле [`telescan.toml`](./telescan.toml). Он загружается автоматически, если находится рядом со скриптом. Альтернативный путь можно указать явно: `python telescan.py --config ./path/to/config.toml …`.

Файл разбит на логические секции:

- `[logging]` — уровень логирования.
- `[check]` — параметры команды проверки (`apis`, `proxies`, `concurrency`, таймауты, пути отчётов, настройки конвертации tdata).
- `[convert]` — параметры команды конвертации (`output`, `timeout`, `parallel`, `keep_temp`, `apis`).

Каждый параметр снабжён комментарием. Значения из конфига выступают в роли дефолтов; параметры можно переопределить флагами CLI. Аргументы `--apis` и `--output` становятся необязательными, если путь указан в конфигурации.

### Формат API ключей

`--apis` ожидает JSON-массив объектов:

```json
[
  {"api_id": 12345, "api_hash": "0123456789abcdef0123456789abcdef", "label": "main"},
  {"api_id": 67890, "api_hash": "fedcba9876543210fedcba9876543210", "label": "backup"}
]
```

Поле `label` опционально и используется в отчётах для наглядности.

### Формат списка прокси

Текстовый файл, по одному адресу на строку. Допускаются варианты:

```
socks5://user:pass@127.0.0.1:9050
http://proxy.example.com:8080
username:password@10.0.0.2:1080
```

Если схема не указана, по умолчанию используется `socks5`.

## Использование

### Проверка сессий

```bash
python telescan.py check \
  /path/to/sessions \
  --config telescan.toml
```

В качестве источников можно передавать:

- одиночные `.session` файлы;
- директории с сессиями;
- CSV файлы со столбцами `key` и `string_session`;
- каталоги `tdata` (при наличии `opentele`).

Дополнительно можно указать:

- `--tdata-root` — каталог, в котором лежат несколько поддиректорий `tdata`;
- `--session-dir` — каталог с `.session` файлами, добавляемый к остальным источникам.

Результаты сохраняются в CSV/JSON файлы, путь к основному отчёту задаётся параметром `out`. Для источников `tdata` конвертированные `.session` файлы сохраняются в `convert_out`, формируется `convert_report.json`.

### Конвертация

```bash
python telescan.py convert tdata-to-session \
  /path/to/tdata \
  --config telescan.toml
```

Для обратного преобразования (`session-to-tdata`) необходимо указать `--apis` (или прописать путь в конфигурации). Дополнительные параметры: `--timeout`, `--parallel`, `--keep-temp`.

## Отчётность

После проверки создаются файлы:

- основной CSV (`report.csv`) со всеми полями `CheckResult`;
- `valid.csv` и `invalid.csv` с разбивкой по статусу;
- директории `valid_sessions` и `invalid_sessions` с копиями `.session` файлов.

Для операций конвертации формируется `convert_report.json` со сводной информацией по каждому элементу.

## Полезные советы

- Используйте отдельные API ключи для одновременных проверок, чтобы снизить риск ограничений Telegram.
- При большом количестве прокси имеет смысл выбрать стратегию `round` или `sticky` для равномерного распределения нагрузки.
- Уровень логирования можно временно повысить до `DEBUG` через конфигурационный файл при отладке.
